<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ERP BB Forros</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

<style>
:root{
--vinho:#8a0000;
--preto:#111;
}
*{margin:0;padding:0;box-sizing:border-box;font-family:Segoe UI;}
body{background:#f4f7f6;}

.login{
position:fixed;
width:100%;height:100%;
background:#1a0505;
display:flex;
align-items:center;
justify-content:center;
}
.login-box{
background:#fff;
padding:40px;
border-radius:10px;
width:350px;
text-align:center;
}
.login-box img{height:90px;margin-bottom:20px;}
.login-box input{
width:100%;
padding:12px;
margin-bottom:10px;
}
button{
padding:10px 20px;
background:var(--vinho);
color:#fff;
border:none;
cursor:pointer;
}
#app{display:none;}
header{
background:#fff;
padding:15px;
display:flex;
justify-content:space-between;
align-items:center;
border-bottom:1px solid #ddd;
}
.layout{display:flex;height:90vh;}
aside{
width:220px;
background:var(--preto);
color:#fff;
padding:15px;
}
aside button{
width:100%;
margin-bottom:10px;
background:#222;
}
main{
flex:1;
padding:25px;
overflow:auto;
}
.card{
background:#fff;
padding:20px;
margin-bottom:20px;
border-radius:8px;
}
table{
width:100%;
border-collapse:collapse;
}
th,td{
padding:10px;
border:1px solid #eee;
}
th{background:#f0f0f0;}
input,select{
padding:8px;
width:100%;
margin-bottom:8px;
}
@media(max-width:768px){
.layout{flex-direction:column;}
aside{width:100%;}
}
</style>
</head>
<body>

<div class="login" id="login">
<div class="login-box">
<img src="LogoBB.png">
<h3>SISTEMA BB</h3>
<input id="user" placeholder="Usuário">
<input id="pass" type="password" placeholder="Senha">
<button onclick="login()">Entrar</button>
</div>
</div>

<div id="app">
<header>
<div><b>BB COMÉRCIO DE FORROS</b></div>
<div id="data"></div>
</header>

<div class="layout">
<aside>
<button onclick="render('fin')">Financeiro</button>
<button onclick="render('cli')">Clientes</button>
<button onclick="render('ped')">Novo Pedido</button>
</aside>
<main id="conteudo"></main>
</div>
</div>

<script>
const DB="https://erp-bb-forros-default-rtdb.firebaseio.com";

document.getElementById("data").innerText=new Date().toLocaleDateString('pt-br');

function login(){
if(document.getElementById("user").value==="admin"){
document.getElementById("login").style.display="none";
document.getElementById("app").style.display="block";
render('fin');
}else{alert("Acesso negado");}
}

async function render(tela){
const c=document.getElementById("conteudo");

if(tela==="fin"){
const r=await fetch(DB+"/pedidos.json");
const d=await r.json();
let total=0,rows="";
if(d){
Object.values(d).forEach(p=>{
total+=parseFloat(p.total||0);
rows+=`<tr><td>${p.data}</td><td>${p.num}</td><td>${p.cliente}</td><td>R$ ${p.total}</td></tr>`;
});
}
c.innerHTML=`
<h2>Financeiro</h2>
<div class="card"><h3>Faturamento: R$ ${total.toFixed(2)}</h3></div>
<div class="card">
<table>
<tr><th>Data</th><th>Pedido</th><th>Cliente</th><th>Total</th></tr>
${rows}
</table>
</div>`;
}

if(tela==="cli"){
const r=await fetch(DB+"/clientes.json");
const d=await r.json();
let rows="";
if(d){
Object.entries(d).forEach(([id,p])=>{
rows+=`<tr>
<td>${p.nome}</td>
<td>${p.tel}</td>
<td>
<button onclick="editarCliente('${id}','${p.nome}','${p.tel}')">Editar</button>
<button onclick="excluir('${id}','clientes')">Excluir</button>
</td>
</tr>`;
});
}
c.innerHTML=`
<h2>Clientes</h2>
<div class="card">
<input id="cnome" placeholder="Nome">
<input id="ctel" placeholder="Telefone">
<button onclick="salvarCliente()">Salvar</button>
</div>
<div class="card">
<table>
<tr><th>Nome</th><th>Telefone</th><th>Ações</th></tr>
${rows}
</table>
</div>`;
}

if(tela==="ped"){
const r=await fetch(DB+"/clientes.json");
const d=await r.json();
let op="";
if(d) Object.values(d).forEach(p=>{
op+=`<option value="${p.nome}">${p.nome}</option>`;
});
c.innerHTML=`
<h2>Novo Pedido</h2>
<div class="card">
<input id="pnum" placeholder="Número Pedido">
<select id="pcli">${op}</select>
<input id="pdesc" placeholder="Produto">
<input id="pval" placeholder="Valor">
<button onclick="salvarPedido()">Salvar e Gerar PDF</button>
</div>`;
}
}

async function salvarCliente(){
const nome=document.getElementById("cnome").value;
const tel=document.getElementById("ctel").value;
await fetch(DB+"/clientes.json",{method:"POST",body:JSON.stringify({nome,tel})});
render('cli');
}

async function excluir(id,tabela){
if(confirm("Deseja excluir?")){
await fetch(DB+"/"+tabela+"/"+id+".json",{method:"DELETE"});
render('cli');
}
}

async function salvarPedido(){
const num=document.getElementById("pnum").value;
if(!num){alert("Informe o número do pedido!");return;}
const cliente=document.getElementById("pcli").value;
const desc=document.getElementById("pdesc").value;
const val=document.getElementById("pval").value;
const pedido={
num,
cliente,
total:val,
data:new Date().toLocaleDateString('pt-br')
};
await fetch(DB+"/pedidos.json",{method:"POST",body:JSON.stringify(pedido)});
gerarPDF(cliente,num,desc,val);
render('fin');
}

async function gerarPDF(cliente,num,desc,val){
const {jsPDF}=window.jspdf;
const doc=new jsPDF();

const img=new Image();
img.src="LogoBB.png";
await new Promise(res=>img.onload=res);

const canvas=document.createElement("canvas");
canvas.width=img.width;
canvas.height=img.height;
canvas.getContext("2d").drawImage(img,0,0);
const imgData=canvas.toDataURL("image/png");

doc.addImage(imgData,"PNG",10,10,40,20);
doc.text("BB COMÉRCIO DE FORROS E DIVISÓRIAS LTDA",60,20);
doc.text("Pedido Nº: "+num,10,40);
doc.text("Cliente: "+cliente,10,50);

doc.autoTable({
startY:60,
head:[["Produto","Valor"]],
body:[[desc,"R$ "+val]]
});

doc.save("Pedido_"+num+".pdf");
}
</script>

</body>
</html>
