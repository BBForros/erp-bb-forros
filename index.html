<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Sistema BB</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body{margin:0;font-family:Arial;background:#f4f4f4;}
header{background:#8B0000;color:white;padding:15px;text-align:center;font-size:22px;font-weight:bold;}
nav{background:#5a0000;display:flex;flex-wrap:wrap;}
nav button{flex:1;padding:12px;border:none;background:#5a0000;color:white;font-weight:bold;cursor:pointer;}
nav button:hover{background:#8B0000;}
.container{padding:20px;}
.card{background:white;padding:15px;margin-bottom:15px;border-radius:8px;box-shadow:0 2px 5px rgba(0,0,0,0.1);}
input,select{width:100%;padding:8px;margin:5px 0;}
button.acao{background:#8B0000;color:white;border:none;padding:10px;cursor:pointer;width:100%;margin-top:5px;}
button.acao:hover{background:#5a0000;}
table{width:100%;border-collapse:collapse;}
th,td{border:1px solid #ddd;padding:8px;text-align:center;}
th{background:#8B0000;color:white;}
@media(max-width:600px){nav button{flex:100%;}}
</style>
</head>

<body>

<header>Sistema BB</header>

<nav>
<button onclick="render('estoque')">ðŸ“¦ Estoque</button>
<button onclick="render('pedido')">ðŸ§¾ Pedido</button>
<button onclick="render('financeiro')">ðŸ“Š Financeiro</button>
<button onclick="render('contas')">ðŸ’³ Contas</button>
</nav>

<div class="container" id="conteudo"></div>

<script>
const DB="COLE_SUA_URL_FIREBASE_AQUI";

function render(tela){
const c=document.getElementById("conteudo");

if(tela==="estoque"){
c.innerHTML=`
<div class="card">
<h2>Cadastro de Produto</h2>
<input id="produto" placeholder="Produto">
<input id="quantidade" type="number" placeholder="Quantidade">
<input id="precoCusto" type="number" placeholder="PreÃ§o de Custo">
<input id="precoVenda" type="number" placeholder="PreÃ§o de Venda">
<button class="acao" onclick="salvarEstoque()">Salvar</button>
</div>
<div class="card"><div id="listaEstoque"></div></div>`;
carregarEstoque();
}

if(tela==="pedido"){
c.innerHTML=`
<div class="card">
<h2>Novo Pedido</h2>
<input id="numPedido" placeholder="NÃºmero do Pedido">
<input id="cliente" placeholder="Cliente">
<input id="produtoPedido" placeholder="Produto">
<input id="quantPedido" type="number" placeholder="Quantidade">
<input id="valorVenda" type="number" placeholder="Valor unitÃ¡rio de venda">
<button class="acao" onclick="salvarPedido()">Finalizar Pedido</button>
</div>`;
}

if(tela==="financeiro"){dashboardFinanceiro();}
if(tela==="contas"){renderContas();}
}

async function salvarEstoque(){
await fetch(DB+"/estoque.json",{method:"POST",
body:JSON.stringify({
produto:produto.value,
quantidade:parseInt(quantidade.value),
precoCusto:parseFloat(precoCusto.value),
precoVenda:parseFloat(precoVenda.value)
})});
render('estoque');
}

async function carregarEstoque(){
const r=await fetch(DB+"/estoque.json");
const d=await r.json();
let html="<table><tr><th>Produto</th><th>Qtd</th><th>Custo</th><th>Venda</th></tr>";
if(d){Object.values(d).forEach(p=>{
html+=`<tr><td>${p.produto}</td><td>${p.quantidade}</td><td>${p.precoCusto}</td><td>${p.precoVenda}</td></tr>`;
});}
html+="</table>";
listaEstoque.innerHTML=html;
}

async function salvarPedido(){
if(!numPedido.value){alert("Pedido sem nÃºmero!");return;}

const r=await fetch(DB+"/estoque.json");
const estoque=await r.json();
let total=0,lucro=0,margem=0;

for(const [id,item] of Object.entries(estoque)){
if(item.produto===produtoPedido.value){

let qtd=parseInt(quantPedido.value);
let novaQtd=item.quantidade-qtd;
if(novaQtd<0){alert("Estoque insuficiente");return;}

total=qtd*parseFloat(valorVenda.value);
lucro=(valorVenda.value-item.precoCusto)*qtd;
margem=(lucro/total)*100;

await fetch(DB+"/estoque/"+id+".json",{method:"PUT",
body:JSON.stringify({...item,quantidade:novaQtd})});
break;
}
}

await fetch(DB+"/pedidos.json",{method:"POST",
body:JSON.stringify({
num:numPedido.value,
cliente:cliente.value,
produto:produtoPedido.value,
quantidade:quantPedido.value,
total:total,
lucro:lucro,
margem:margem,
data:new Date().toISOString().split("T")[0]
})});

gerarPDF(total,lucro,margem);
alert("Pedido Finalizado!");
render('financeiro');
}

function gerarPDF(total,lucro,margem){
const { jsPDF } = window.jspdf;
const doc=new jsPDF();
doc.addImage("LogoBB.png","PNG",10,10,40,20);
doc.text("Resumo do Pedido",10,40);
doc.text("Total: R$ "+total.toFixed(2),10,50);
doc.text("Lucro: R$ "+lucro.toFixed(2),10,60);
doc.text("Margem: "+margem.toFixed(2)+"%",10,70);
doc.save("pedido.pdf");
}

async function dashboardFinanceiro(){
const r=await fetch(DB+"/pedidos.json");
const d=await r.json();

let fat=0,luc=0,labels=[],valores=[];
if(d){Object.values(d).forEach(p=>{
fat+=p.total;
luc+=p.lucro;
labels.push(p.data);
valores.push(p.total);
});}

conteudo.innerHTML=`
<div class="card">
<h2>Financeiro</h2>
<input type="date" id="dataInicio">
<input type="date" id="dataFim">
<button class="acao" onclick="dashboardFinanceiro()">Filtrar</button>
<h3>Faturamento: R$ ${fat.toFixed(2)}</h3>
<h3 style="color:green;">Lucro: R$ ${luc.toFixed(2)}</h3>
</div>
<div class="card"><canvas id="grafico"></canvas></div>`;

new Chart(grafico,{
type:'bar',
data:{labels:labels,
datasets:[{label:'Faturamento',data:valores,backgroundColor:'#8B0000'}]}
});
}

function renderContas(){
conteudo.innerHTML=`
<div class="card">
<h2>Nova Conta</h2>
<select id="tipoConta">
<option value="pagar">Conta a Pagar</option>
<option value="receber">Conta a Receber</option>
</select>
<input id="descConta" placeholder="DescriÃ§Ã£o">
<input id="valorConta" type="number" placeholder="Valor">
<input id="dataConta" type="date">
<button class="acao" onclick="salvarConta()">Salvar</button>
</div>
<div class="card"><div id="listaContas"></div></div>`;
carregarContas();
}

async function salvarConta(){
await fetch(DB+"/contas.json",{method:"POST",
body:JSON.stringify({
tipo:tipoConta.value,
desc:descConta.value,
valor:parseFloat(valorConta.value),
data:dataConta.value
})});
render('contas');
}

async function carregarContas(){
const r=await fetch(DB+"/contas.json");
const d=await r.json();
let pagar=0,receber=0,html="<table><tr><th>Tipo</th><th>Desc</th><th>Valor</th><th>Data</th></tr>";
if(d){Object.values(d).forEach(c=>{
if(c.tipo==="pagar")pagar+=c.valor;
if(c.tipo==="receber")receber+=c.valor;
html+=`<tr><td>${c.tipo}</td><td>${c.desc}</td><td>${c.valor}</td><td>${c.data}</td></tr>`;
});}
html+="</table>";
html+=`<h3>Total a Pagar: R$ ${pagar.toFixed(2)}</h3>`;
html+=`<h3>Total a Receber: R$ ${receber.toFixed(2)}</h3>`;
listaContas.innerHTML=html;
}

render('estoque');
</script>
</body>
</html>
