<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Sistema BB</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{
margin:0;
font-family:Arial;
background:#f4f4f4;
}
header{
background:#8B0000;
color:white;
padding:15px;
text-align:center;
font-size:20px;
font-weight:bold;
}
nav{
background:#600000;
padding:10px;
display:flex;
gap:10px;
flex-wrap:wrap;
}
nav button{
background:white;
border:none;
padding:8px 15px;
cursor:pointer;
border-radius:5px;
font-weight:bold;
}
nav button:hover{
background:#ddd;
}
.container{
padding:20px;
}
.card{
background:white;
padding:15px;
margin-bottom:15px;
border-radius:6px;
box-shadow:0 2px 5px rgba(0,0,0,0.1);
}
input, select{
padding:8px;
margin:5px 0;
width:100%;
}
button.acao{
background:#8B0000;
color:white;
border:none;
padding:8px 15px;
cursor:pointer;
border-radius:4px;
margin-top:5px;
}
table{
width:100%;
border-collapse:collapse;
margin-top:10px;
}
th,td{
border:1px solid #ddd;
padding:6px;
text-align:left;
}
th{
background:#eee;
}
@media(max-width:768px){
nav{flex-direction:column;}
}
</style>
</head>

<body>

<header>BB COMÉRCIO DE FORROS</header>

<nav>
<button onclick="render('dashboard')">Dashboard</button>
<button onclick="render('estoque')">Estoque</button>
<button onclick="render('pedido')">Pedido</button>
<button onclick="render('financeiro')">Financeiro</button>
<button onclick="render('contas')">Contas</button>
</nav>

<div class="container" id="app"></div>

<script>

let estoque = [];
let pedidos = [];
let contas = [];
let itensPedido = [];
let totalPedido = 0;

function render(tela){

const app = document.getElementById("app");

if(tela==="dashboard"){
app.innerHTML=`
<div class="card">
<h2>Resumo Financeiro</h2>
<p>Faturamento: R$ ${totalFaturamento().toFixed(2)}</p>
<p>Lucro: R$ ${totalLucro().toFixed(2)}</p>
<p>Margem Média: ${margemMedia().toFixed(2)}%</p>
<canvas id="grafico"></canvas>
</div>`;
gerarGrafico();
}

if(tela==="estoque"){
app.innerHTML=`
<div class="card">
<h2>Cadastro de Produto</h2>
<input id="prod" placeholder="Produto">
<input id="qtd" type="number" placeholder="Quantidade">
<input id="custo" type="number" placeholder="Preço de Custo">
<input id="venda" type="number" placeholder="Preço de Venda">
<button class="acao" onclick="addEstoque()">Salvar</button>
</div>
<div class="card">
<h2>Lista de Produtos</h2>
${listaEstoque()}
</div>`;
}

if(tela==="pedido"){
app.innerHTML=`
<div class="card">
<h2>Novo Pedido</h2>
<input id="numPedido" placeholder="Número do Pedido">
<select id="selectProd">${optionsProdutos()}</select>
<input id="qtdPed" type="number" placeholder="Quantidade">
<button class="acao" onclick="addItem()">Adicionar</button>
${tabelaPedido()}
<p>Total: R$ ${totalPedido.toFixed(2)}</p>
<button class="acao" onclick="finalizarPedido()">Finalizar</button>
</div>`;
}

if(tela==="financeiro"){
app.innerHTML=`
<div class="card">
<h2>Financeiro</h2>
<input type="date" id="inicio">
<input type="date" id="fim">
<button class="acao" onclick="filtrar()">Filtrar</button>
${listaPedidos(pedidos)}
</div>`;
}

if(tela==="contas"){
app.innerHTML=`
<div class="card">
<h2>Nova Conta</h2>
<input id="descConta" placeholder="Descrição">
<input id="valorConta" type="number" placeholder="Valor">
<select id="tipoConta">
<option value="Pagar">Pagar</option>
<option value="Receber">Receber</option>
</select>
<button class="acao" onclick="addConta()">Salvar</button>
</div>
<div class="card">
${listaContas()}
</div>`;
}

}

function addEstoque(){
estoque.push({
produto:prod.value,
qtd:parseFloat(qtd.value),
custo:parseFloat(custo.value),
venda:parseFloat(venda.value)
});
render('estoque');
}

function listaEstoque(){
let html="<table><tr><th>Produto</th><th>Qtd</th><th>Custo</th><th>Venda</th></tr>";
estoque.forEach(e=>{
html+=`<tr>
<td>${e.produto}</td>
<td>${e.qtd}</td>
<td>${e.custo}</td>
<td>${e.venda}</td>
</tr>`;
});
html+="</table>";
return html;
}

function optionsProdutos(){
let opt="";
estoque.forEach((e,i)=>{
opt+=`<option value="${i}">${e.produto}</option>`;
});
return opt;
}

function addItem(){
const i=selectProd.value;
const q=parseFloat(qtdPed.value);
if(!q||q<=0)return;

const prod=estoque[i];
const sub=prod.venda*q;
totalPedido+=sub;

itensPedido.push({
produto:prod.produto,
qtd:q,
venda:prod.venda,
custo:prod.custo,
sub:sub
});

render('pedido');
}

function tabelaPedido(){
let html="<table><tr><th>Produto</th><th>Qtd</th><th>Valor</th><th>Subtotal</th></tr>";
itensPedido.forEach(i=>{
html+=`<tr>
<td>${i.produto}</td>
<td>${i.qtd}</td>
<td>${i.venda}</td>
<td>${i.sub.toFixed(2)}</td>
</tr>`;
});
html+="</table>";
return html;
}

function finalizarPedido(){

const numero=numPedido.value;
if(!numero){alert("Pedido sem número");return;}

let lucro=0;

itensPedido.forEach(i=>{
const prod=estoque.find(e=>e.produto===i.produto);
prod.qtd-=i.qtd;
lucro+=(i.venda-i.custo)*i.qtd;
});

const margem=(lucro/totalPedido)*100;

pedidos.push({
numero,
data:new Date().toLocaleDateString(),
total:totalPedido,
lucro,
margem
});

gerarPDF(numero);

itensPedido=[];
totalPedido=0;

render('dashboard');
}

function gerarPDF(numero){
const { jsPDF } = window.jspdf;
const doc=new jsPDF();
const img=new Image();
img.src="LogoBB.png";
img.onload=function(){
doc.addImage(img,"PNG",10,10,40,20);
doc.text("Pedido Nº: "+numero,10,40);
doc.text("Total: R$ "+totalPedido.toFixed(2),10,50);
doc.save("Pedido_"+numero+".pdf");
}
}

function totalFaturamento(){
return pedidos.reduce((t,p)=>t+p.total,0);
}

function totalLucro(){
return pedidos.reduce((t,p)=>t+p.lucro,0);
}

function margemMedia(){
if(pedidos.length===0)return 0;
return pedidos.reduce((t,p)=>t+p.margem,0)/pedidos.length;
}

function gerarGrafico(){
const ctx=document.getElementById("grafico");
new Chart(ctx,{
type:'bar',
data:{
labels:['Faturamento','Lucro'],
datasets:[{
data:[totalFaturamento(),totalLucro()]
}]
}
});
}

function listaPedidos(lista){
let html="<table><tr><th>Data</th><th>Nº</th><th>Total</th><th>Lucro</th><th>Margem%</th></tr>";
lista.forEach(p=>{
html+=`<tr>
<td>${p.data}</td>
<td>${p.numero}</td>
<td>${p.total.toFixed(2)}</td>
<td>${p.lucro.toFixed(2)}</td>
<td>${p.margem.toFixed(2)}</td>
</tr>`;
});
html+="</table>";
return html;
}

function filtrar(){
const i=inicio.value;
const f=fim.value;
if(!i||!f)return;
const lista=pedidos.filter(p=>{
const d=p.data.split('/').reverse().join('-');
return d>=i&&d<=f;
});
app.innerHTML=`<div class="card">${listaPedidos(lista)}</div>`;
}

function addConta(){
contas.push({
desc:descConta.value,
valor:parseFloat(valorConta.value),
tipo:tipoConta.value,
data:new Date().toLocaleDateString()
});
render('contas');
}

function listaContas(){
let html="<table><tr><th>Data</th><th>Descrição</th><th>Tipo</th><th>Valor</th></tr>";
contas.forEach(c=>{
html+=`<tr>
<td>${c.data}</td>
<td>${c.desc}</td>
<td>${c.tipo}</td>
<td>${c.valor}</td>
</tr>`;
});
html+="</table>";
return html;
}

render('dashboard');

</script>
</body>
</html>
