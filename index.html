<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ERP BB Forros</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
:root{
--vinho:#8a0000;
--preto:#111;
}
*{margin:0;padding:0;box-sizing:border-box;font-family:Segoe UI;}
body{background:#f4f7f6;}

.login{
position:fixed;
width:100%;height:100%;
background:#1a0505;
display:flex;
align-items:center;
justify-content:center;
}
.login-box{
background:#fff;
padding:40px;
border-radius:10px;
width:360px;
text-align:center;
}
.login-box img{height:90px;margin-bottom:20px;}
.login-box input{
width:100%;
padding:12px;
margin-bottom:10px;
}
button{
padding:10px 20px;
background:var(--vinho);
color:#fff;
border:none;
cursor:pointer;
border-radius:4px;
}
#app{display:none;}
header{
background:#fff;
padding:15px;
display:flex;
justify-content:space-between;
align-items:center;
border-bottom:1px solid #ddd;
}
.layout{display:flex;height:90vh;}
aside{
width:230px;
background:var(--preto);
color:#fff;
padding:15px;
}
aside button{
width:100%;
margin-bottom:10px;
background:#222;
}
main{
flex:1;
padding:25px;
overflow:auto;
}
.card{
background:#fff;
padding:20px;
margin-bottom:20px;
border-radius:8px;
}
table{
width:100%;
border-collapse:collapse;
}
th,td{
padding:10px;
border:1px solid #eee;
}
th{background:#f0f0f0;}
input,select{
padding:8px;
width:100%;
margin-bottom:8px;
}
.form-grid{
display:grid;
grid-template-columns:repeat(4,1fr);
gap:10px;
}
.full{grid-column:span 4;}

@media(max-width:768px){
.layout{flex-direction:column;}
aside{width:100%;}
.form-grid{grid-template-columns:1fr;}
.full{grid-column:span 1;}
}
</style>
</head>
<body>

<!-- LOGIN -->
<div class="login" id="login">
<div class="login-box">
<img src="LogoBB.png">
<h3>SISTEMA BB</h3>
<input id="user" placeholder="UsuÃ¡rio">
<input id="pass" type="password" placeholder="Senha">
<button onclick="login()">Entrar</button>
</div>
</div>

<!-- APP -->
<div id="app">
<header>
<div><b>BB COMÃ‰RCIO DE FORROS E DIVISÃ“RIAS LTDA</b></div>
<div id="data"></div>
</header>

<div class="layout">
<aside>
<button onclick="render('fin')">ðŸ“Š Dashboard</button>
<button onclick="render('cli')">ðŸ‘¥ Clientes</button>
<button onclick="render('ped')">ðŸ›’ Novo Pedido</button>
<button onclick="render('est')">ðŸ“¦ Estoque</button>
<button onclick="location.reload()">ðŸšª Sair</button>
</aside>

<main id="conteudo"></main>
</div>
</div>

<script>
const DB="https://erp-bb-forros-default-rtdb.firebaseio.com";
document.getElementById("data").innerText=new Date().toLocaleDateString('pt-br');

function login(){
if(document.getElementById("user").value==="admin"){
document.getElementById("login").style.display="none";
document.getElementById("app").style.display="block";
render('fin');
}else{alert("Acesso negado");}
}

async function render(tela){
const c=document.getElementById("conteudo");

if(tela==="fin"){
const r=await fetch(DB+"/pedidos.json");
const d=await r.json();

let faturamento=0;
let lucroTotal=0;
let rows="";
let labels=[];
let valores=[];

if(d){
Object.values(d).forEach(p=>{
faturamento+=parseFloat(p.total||0);
lucroTotal+=parseFloat(p.lucro||0);
labels.push(p.data);
valores.push(p.total);

rows+=`
<tr>
<td>${p.data}</td>
<td>${p.numPedido}</td>
<td>${p.cliente}</td>
<td>R$ ${parseFloat(p.total).toFixed(2)}</td>
<td style="color:green;">R$ ${parseFloat(p.lucro||0).toFixed(2)}</td>
</tr>`;
});
}

c.innerHTML=`
<h2>ðŸ“Š Dashboard Financeiro</h2>

<div class="card">
<h3>Faturamento Total: R$ ${faturamento.toFixed(2)}</h3>
<h3 style="color:green;">Lucro Total: R$ ${lucroTotal.toFixed(2)}</h3>
</div>

<div class="card">
<canvas id="grafico"></canvas>
</div>

<div class="card">
<table>
<tr>
<th>Data</th>
<th>Pedido</th>
<th>Cliente</th>
<th>Venda</th>
<th>Lucro</th>
</tr>
${rows}
</table>
</div>
`;

new Chart(document.getElementById('grafico'),{
type:'bar',
data:{
labels:labels,
datasets:[{
label:'Faturamento',
data:valores,
backgroundColor:'#8a0000'
}]
}
});
}

if(tela==="cli"){
c.innerHTML=`<h2>Clientes</h2><div class="card">MÃ³dulo simplificado</div>`;
}

if(tela==="ped"){
const r=await fetch(DB+"/estoque.json");
const estoque=await r.json();
let op="<option value=''>Selecione Produto</option>";
if(estoque){
Object.values(estoque).forEach(p=>{
op+=`<option value="${p.produto}">${p.produto}</option>`;
});
}

c.innerHTML=`
<h2>Novo Pedido</h2>
<div class="card">
<input id="pnum" placeholder="NÃºmero do Pedido">
<select id="pprod">${op}</select>
<input id="pval" type="number" placeholder="Valor de Venda">
<button onclick="salvarPedido()">Salvar Pedido</button>
</div>`;
}

if(tela==="est"){
const r=await fetch(DB+"/estoque.json");
const d=await r.json();
let rows="";
if(d){
Object.entries(d).forEach(([id,i])=>{
rows+=`
<tr>
<td>${i.produto}</td>
<td>${i.quantidade}</td>
<td>R$ ${parseFloat(i.precoCusto).toFixed(2)}</td>
<td>R$ ${parseFloat(i.precoVenda).toFixed(2)}</td>
</tr>`;
});
}
c.innerHTML=`
<h2>Estoque</h2>
<div class="card">
<form class="form-grid" onsubmit="salvarEstoque(event)">
<input class="full" id="eprod" placeholder="Produto" required>
<input id="eqtd" type="number" placeholder="Quantidade" required>
<input id="ecusto" type="number" step="0.01" placeholder="PreÃ§o de Custo" required>
<input id="evenda" type="number" step="0.01" placeholder="PreÃ§o de Venda" required>
<button class="full" type="submit">Salvar Produto</button>
</form>
</div>
<div class="card">
<table>
<tr><th>Produto</th><th>Qtd</th><th>Custo</th><th>Venda</th></tr>
${rows}
</table>
</div>`;
}
}

async function salvarEstoque(e){
e.preventDefault();
await fetch(DB+"/estoque.json",{
method:"POST",
body:JSON.stringify({
produto:eprod.value,
quantidade:eqtd.value,
precoCusto:ecusto.value,
precoVenda:evenda.value
})
});
render('est');
}

async function salvarPedido(){
const num=pnum.value;
if(!num){alert("Informe o nÃºmero do pedido");return;}

const produto=pprod.value;
const venda=parseFloat(pval.value);

const r=await fetch(DB+"/estoque.json");
const estoque=await r.json();

for(const [id,item] of Object.entries(estoque)){
if(item.produto===produto){

let novaQtd=parseInt(item.quantidade)-1;
if(novaQtd<0){alert("Estoque insuficiente");return;}

let lucro=venda-parseFloat(item.precoCusto);

await fetch(DB+"/estoque/"+id+".json",{
method:"PUT",
body:JSON.stringify({
produto:item.produto,
quantidade:novaQtd,
precoCusto:item.precoCusto,
precoVenda:item.precoVenda
})
});

await fetch(DB+"/pedidos.json",{
method:"POST",
body:JSON.stringify({
numPedido:num,
cliente:"Venda direta",
produto,
total:venda,
lucro,
data:new Date().toLocaleDateString('pt-br')
})
});

break;
}
}

render('fin');
}
</script>

</body>
</html>
