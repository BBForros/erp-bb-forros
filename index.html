<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ERP BB Forros | Gest√£o Profissional Adminstrativa</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <style>
        :root { --vinho: #800000; --preto: #000000; --fundo-dark: #1a0505; --bg-input: #e8f0fe; }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', Arial, sans-serif; }
        body { background-color: var(--fundo-dark); height: 100vh; overflow: hidden; }

        /* TELA DE LOGIN (IGUAL image_e26cea.png) */
        .login-overlay { position: fixed; inset: 0; background: var(--fundo-dark); display: flex; align-items: center; justify-content: center; z-index: 10000; }
        .login-card { background: white; padding: 40px; border-radius: 20px; width: 420px; text-align: center; box-shadow: 0 15px 35px rgba(0,0,0,0.5); }
        .login-card img { width: 240px; margin-bottom: 20px; }
        .login-card h2 { color: var(--vinho); margin-bottom: 25px; font-weight: bold; }
        .login-card input { width: 100%; padding: 15px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 10px; background: var(--bg-input); font-size: 16px; }
        .btn-acessar { width: 100%; padding: 18px; background: var(--vinho); color: white; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; text-transform: uppercase; font-size: 16px; }

        /* PAINEL PRINCIPAL (IGUAL image_e023c8.png) */
        #main-app { display: none; flex-direction: column; height: 100vh; background: #fff; }
        .header { height: 75px; background: #fff; border-bottom: 1px solid #ddd; display: flex; align-items: center; padding: 0 20px; justify-content: space-between; }
        .header-logo { display: flex; align-items: center; gap: 15px; }
        .header-logo img { height: 50px; }
        .header-logo b { color: var(--vinho); font-size: 22px; text-transform: uppercase; }

        .layout { display: flex; flex: 1; overflow: hidden; }
        
        /* SIDEBAR (IGUAL image_e023c8.png) */
        .sidebar { width: 280px; background: #1a0000; display: flex; flex-direction: column; }
        .nav-menu { flex: 1; padding: 30px 15px; }
        .nav-menu button { width: 100%; padding: 18px; background: transparent; border: none; color: #fca5a5; text-align: left; cursor: pointer; border-radius: 12px; margin-bottom: 15px; font-weight: bold; font-size: 14px; text-transform: uppercase; display: flex; align-items: center; gap: 10px; }
        .nav-menu button:hover, .nav-menu button.active { background: var(--vinho); color: white; }
        .nav-menu button.active { background: #ce1212; }
        .btn-sair-sidebar { background: #000; color: white; padding: 25px; border: none; cursor: pointer; font-weight: bold; width: 100%; letter-spacing: 2px; }

        /* √ÅREA DE CONTE√öDO */
        .main-content { flex: 1; padding: 40px; overflow-y: auto; background: #fdfdfd; }
        .section-title { font-size: 32px; font-weight: bold; margin-bottom: 25px; display: flex; align-items: center; gap: 15px; }
        .card-box { background: white; padding: 30px; border-radius: 15px; border: 1px solid #eee; margin-bottom: 30px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        
        /* FORMUL√ÅRIOS */
        .grid-form { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }
        .full-w { grid-column: 1 / -1; }
        label { display: block; font-size: 12px; font-weight: bold; color: var(--vinho); margin-bottom: 8px; text-transform: uppercase; }
        input, select, textarea { width: 100%; padding: 14px; border: 1px solid #ddd; border-radius: 8px; font-size: 15px; outline: none; }
        .btn-atualizar { background: var(--vinho); color: white; width: 100%; padding: 18px; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; margin-top: 20px; font-size: 16px; }

        /* TABELAS */
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th { text-align: left; padding: 15px; border-bottom: 2px solid #eee; color: #666; font-size: 13px; }
        td { padding: 15px; border-bottom: 1px solid #f9f9f9; font-size: 14px; }
        .badge-edit { background: #ffc107; color: #000; padding: 6px 12px; border-radius: 5px; cursor: pointer; border: none; font-weight: bold; margin-right: 5px; }
        .badge-pdf { background: #16a34a; color: white; padding: 6px 12px; border-radius: 5px; cursor: pointer; border: none; font-weight: bold; }
    </style>
</head>
<body>

    <div id="login-scr" class="login-overlay">
        <div class="login-card">
            <img src="LogoBB.png" alt="BB Forros" onerror="this.src='https://via.placeholder.com/240x100?text=BB+FORROS'">
            <h2>BB GEST√ÉO</h2>
            <input type="text" id="user" placeholder="admin">
            <input type="password" id="pass" placeholder="***">
            <button onclick="realizarLogin()" class="btn-acessar">ACESSAR SISTEMA</button>
        </div>
    </div>

    <div id="main-app">
        <header class="header">
            <div class="header-logo">
                <img src="LogoBB.png" alt="Logo">
                <b>BB COM√âRCIO DE FORROS E DIVIS√ìRIAS LTDA.</b>
            </div>
            <div>Painel: <b style="color:var(--vinho)">Administrador</b></div>
        </header>

        <div class="layout">
            <aside class="sidebar">
                <nav class="nav-menu">
                    <button onclick="show('fin')" id="m-fin">üìä FINANCEIRO</button>
                    <button onclick="show('cli')" id="m-cli">üë• CLIENTES</button>
                    <button onclick="show('ped')" id="m-ped">üõí VENDAS / PEDIDOS</button>
                    <button onclick="show('est')" id="m-est">üì¶ ESTOQUE</button>
                </nav>
                <button onclick="location.reload()" class="btn-sair-sidebar">SAIR</button>
            </aside>

            <main class="main-content" id="view-port"></main>
        </div>
    </div>

    <script>
        const DB = "https://erp-bb-forros-default-rtdb.firebaseio.com";
        let editandoID = null;

        function realizarLogin() {
            if(document.getElementById('user').value === 'admin' && document.getElementById('pass').value === '123') {
                document.getElementById('login-scr').style.display = 'none';
                document.getElementById('main-app').style.display = 'flex';
                show('ped'); // Inicia na tela de pedidos
            } else { alert("Login incorreto!"); }
        }

        async function show(tela) {
            const port = document.getElementById('view-port');
            document.querySelectorAll('.nav-menu button').forEach(b => b.classList.remove('active'));
            if(document.getElementById('m-'+tela)) document.getElementById('m-'+tela).classList.add('active');

            if (tela === 'est') { // IGUAL image_e023c8.png
                port.innerHTML = `
                    <div class="section-title">üì¶ Estoque</div>
                    <div class="card-box">
                        <div class="grid-form">
                            <div class="full-w"><label>MATERIAL</label><input id="emat"></div>
                            <div><label>QTD</label><input id="eqtd" type="number"></div>
                            <div><label>UNID</label><select id="eunid"><option>m¬≤</option><option>Un</option><option>Kg</option></select></div>
                        </div>
                        <button class="btn-atualizar" onclick="salvarEstoque()">ATUALIZAR</button>
                    </div>
                    <div class="card-box">
                        <table><thead><tr><th>Material</th><th>Qtd</th><th>Unid</th></tr></thead><tbody id="lista-est"></tbody></table>
                    </div>`;
                carregarEstoque();
            }

            if (tela === 'ped') { // COM LISTA E EDI√á√ÉO
                const [rCli, rPed] = await Promise.all([fetch(`${DB}/clientes.json`), fetch(`${DB}/pedidos.json`)]);
                const dCli = await rCli.json(); const dPed = await rPed.json();
                const clis = dCli ? Object.values(dCli) : [];
                const peds = dPed ? Object.entries(dPed) : [];

                port.innerHTML = `
                    <div class="section-title">üõí Vendas / Pedidos</div>
                    <div class="card-box">
                        <h3 style="color:var(--vinho); margin-bottom:15px" id="label-venda">Novo Or√ßamento</h3>
                        <div class="grid-form">
                            <div><label>N¬∫ Or√ßamento</label><input id="pnum"></div>
                            <div><label>Data</label><input id="pdata" type="date" value="${new Date().toISOString().split('T')[0]}"></div>
                            <div class="full-w"><label>Cliente</label>
                                <select id="pcli">
                                    <option value="">Selecione o Cliente...</option>
                                    ${clis.map(c => `<option value="${c.nome}" data-tel="${c.tel}" data-end="${c.end}">${c.nome}</option>`).join('')}
                                </select>
                            </div>
                            <div class="full-w"><label>Descri√ß√£o do Servi√ßo/Material</label><textarea id="pmat" style="height:100px"></textarea></div>
                            <div><label>Valor Total R$</label><input id="ptotal" type="number" step="0.01"></div>
                        </div>
                        <button class="btn-atualizar" style="background:#16a34a" onclick="salvarPedido()">SALVAR E GERAR PDF</button>
                    </div>
                    <div class="card-box">
                        <label>Pedidos Emitidos</label>
                        <table>
                            <thead><tr><th>N¬∫</th><th>Cliente</th><th>Valor</th><th>A√ß√µes</th></tr></thead>
                            <tbody>
                                ${peds.reverse().map(([id, p]) => `
                                    <tr>
                                        <td>#${p.numero}</td><td>${p.cliente}</td><td>R$ ${parseFloat(p.total).toLocaleString('pt-br',{minimumFractionDigits:2})}</td>
                                        <td>
                                            <button class="badge-edit" onclick='prepararEdicao("${id}", ${JSON.stringify(p)})'>EDITAR</button>
                                            <button class="badge-pdf" onclick='gerarPDF(${JSON.stringify(p)})'>PDF</button>
                                        </td>
                                    </tr>`).join('')}
                            </tbody>
                        </table>
                    </div>`;
            }

            if (tela === 'cli') {
                port.innerHTML = `
                    <div class="section-title">üë• Clientes</div>
                    <div class="card-box">
                        <div class="grid-form">
                            <div class="full-w"><label>Nome / Raz√£o Social</label><input id="cnome"></div>
                            <div><label>WhatsApp</label><input id="ctel"></div>
                            <div class="full-w"><label>Endere√ßo de Obra</label><input id="cend"></div>
                        </div>
                        <button class="btn-atualizar" onclick="salvarCli()">CADASTRAR CLIENTE</button>
                    </div>`;
            }
        }

        async function salvarPedido() {
            const sel = document.getElementById('pcli');
            const p = {
                numero: document.getElementById('pnum').value, data: document.getElementById('pdata').value,
                cliente: sel.value, tel: sel.options[sel.selectedIndex].getAttribute('data-tel') || "",
                end: sel.options[sel.selectedIndex].getAttribute('data-end') || "",
                material: document.getElementById('pmat').value, total: document.getElementById('ptotal').value
            };
            const url = editandoID ? `${DB}/pedidos/${editandoID}.json` : `${DB}/pedidos.json`;
            await fetch(url, { method: editandoID ? 'PUT' : 'POST', body: JSON.stringify(p) });
            editandoID = null; show('ped'); gerarPDF(p);
        }

        function prepararEdicao(id, p) {
            editandoID = id; document.getElementById('label-venda').innerText = "Editando Or√ßamento #" + p.numero;
            document.getElementById('pnum').value = p.numero; document.getElementById('pdata').value = p.data;
            document.getElementById('pcli').value = p.cliente; document.getElementById('pmat').value = p.material;
            document.getElementById('ptotal').value = p.total; window.scrollTo(0,0);
        }

        async function carregarEstoque() {
            const r = await fetch(`${DB}/estoque.json`);
            const d = await r.json();
            const list = document.getElementById('lista-est');
            if(d) {
                list.innerHTML = Object.values(d).map(e => `<tr><td>${e.mat}</td><td>${e.qtd}</td><td>${e.unid}</td></tr>`).join('');
            }
        }

        async function salvarEstoque() {
            const e = { mat: document.getElementById('emat').value, qtd: document.getElementById('eqtd').value, unid: document.getElementById('eunid').value };
            await fetch(`${DB}/estoque.json`, { method: 'POST', body: JSON.stringify(e) });
            show('est');
        }

        async function salvarCli() {
            const c = { nome: document.getElementById('cnome').value, tel: document.getElementById('ctel').value, end: document.getElementById('cend').value };
            await fetch(`${DB}/clientes.json`, { method: 'POST', body: JSON.stringify(c) });
            alert("Cliente salvo!"); show('cli');
        }

        function gerarPDF(p) {
            const { jsPDF } = window.jspdf; const doc = new jsPDF();
            doc.setFontSize(10); doc.setFont("helvetica", "bold");
            doc.text("BB COM√âRCIO DE FORROS E DIVIS√ìRIAS LTDA", 105, 15, {align:'center'});
            doc.setFontSize(8); doc.setFont("helvetica", "normal");
            doc.text("R. Jo√£o Pereira In√°cio, 397 - Avia√ß√£o - Praia Grande/SP", 105, 20, {align:'center'});
            doc.setTextColor(0, 0, 255); doc.text("SIGA-NOS: @bbforros", 105, 30, {align:'center'});
            doc.setTextColor(0); doc.line(10, 35, 200, 35);
            doc.text(`Or√ßamento: ${p.numero} | Data: ${p.data.split('-').reverse().join('/')}`, 15, 45);
            doc.text(`Cliente: ${p.cliente}`, 15, 52); doc.text(`Endere√ßo: ${p.end}`, 15, 59);
            doc.setTextColor(255, 0, 0);
            doc.text("* Garantia de 2 anos material e 2 anos m√£o de obra", 15, 75);
            doc.text("OBS: 50% NO FECHAMENTO E RESTANTE A COMBINAR", 15, 82);
            doc.setTextColor(0);
            doc.autoTable({ startY: 90, head: [['DESCRI√á√ÉO', 'TOTAL']], body: [[p.material, `R$ ${parseFloat(p.total).toLocaleString('pt-br',{minimumFractionDigits:2})}`]], headStyles: { fillColor: [128, 0, 0] } });
            doc.setTextColor(0, 0, 255); doc.text("Dados para pagamento: PIX bbforros@bbforros.com.br", 15, doc.lastAutoTable.finalY + 10);
            doc.save(`BB_Orcamento_${p.numero}.pdf`);
        }
    </script>
</body>
</html>
